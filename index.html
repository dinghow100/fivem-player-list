<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FiveM Global Player Finder</title>
<style>
  :root{--bg:#0b0e13;--card:#11161f;--fg:#e6edf3;--muted:#9aa4b2;--border:#1f2a37;--accent:#7aa2ff}
  *{box-sizing:border-box}body{margin:0;background:#0b0e13;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:24px 16px 6px;text-align:center}
  h1{margin:0 0 6px;font-size:24px} .sub{color:var(--muted);font-size:13px;margin:0}
  .card{max-width:1100px;margin:18px auto;background:#11161f;border:1px solid var(--border);border-radius:14px}
  .content{padding:16px}
  form{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--fg)}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0e1524;color:var(--fg);cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#5b87ff);border:none;color:#fff}
  .chips{grid-column:1 / -1;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-top:4px}
  .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b1220}
  .dot{width:8px;height:8px;border-radius:50%} #status{font-size:12px;color:var(--muted);margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  thead{position:sticky;top:0;background:#0c1220;box-shadow:0 1px 0 var(--border)}
  th,td{padding:9px 10px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
</style>
</head>
<body>
<header>
  <h1>FiveM Global Player Finder</h1>
  <p class="sub">Search a player name across the live CFX masterlist. Results stream in as servers are scanned.</p>
</header>

<section class="card"><div class="content">
  <form id="f">
    <input id="q" type="text" placeholder="Type a player name (e.g. matthew)"/>
    <button class="btn primary" type="submit">Search</button>
    <button class="btn" type="button" id="stopBtn">Stop</button>
    <div class="chips">
      <label class="chip"><input id="exact" type="checkbox"/> Exact match</label>
      <label class="chip"><input id="hl" type="checkbox" checked/> Highlight</label>
      <span class="chip"><input id="cap" type="checkbox" checked/> Cap 1500</span>
      <span class="chip"><span class="dot" id="led" style="background:#64748b"></span><span id="state">Idle</span></span>
      <span class="chip">Proxy: fivemplayerlist.dinghow1.workers.dev</span>
    </div>
    <div id="status">Idle.</div>
  </form>

  <table id="t"><thead>
    <tr><th>Player</th><th>Server</th><th>Server ID</th><th>Players</th><th>Join</th><th>Details</th></tr>
  </thead><tbody></tbody></table>
</div></section>

<script>
const PROXY = "https://fivemplayerlist.dinghow1.workers.dev/stream"; // <-- your proxy (hard-wired)
// Hard-wired proxy for GitHub Pages
const STREAM_CANDIDATES = [
  "https://fivemplayerlist.dinghow1.workers.dev/stream",
  "https://servers-frontend.fivem.net/api/servers/stream",
  () => `https://servers-frontend.fivem.net/api/servers/stream/${Math.floor(Date.now()/1000)}`
];

const DETAIL_URL = id => `https://servers.fivem.net/servers/detail/${id}`;
const JOIN_URL   = id => `https://cfx.re/join/${id}`;

let controller=null, stopFlag=false, resultCount=0;
const q=document.getElementById('q'), exact=document.getElementById('exact'), cap=document.getElementById('cap'), hl=document.getElementById('hl');
const statusEl=document.getElementById('status'), led=document.getElementById('led'), state=document.getElementById('state');
const tbody=document.querySelector('#t tbody');

document.getElementById('f').addEventListener('submit', e=>{
  e.preventDefault();
  const query=q.value.trim(); if(!query){alert('Enter a player name');return;}
  tbody.innerHTML=''; resultCount=0; stopFlag=false; setState('Connecting…','#7aa2ff');
  document.getElementById('stopBtn').disabled=false;
  runSearch(PROXY,query,exact.checked).catch(err=>{
    setState('Error','#ef4444'); statusEl.textContent='Error: '+(err.message||err);
  }).finally(()=>{document.getElementById('stopBtn').disabled=true;});
});
document.getElementById('stopBtn').onclick=()=>{stopFlag=true; if(controller)controller.abort(); setState('Stopped','#f59e0b');};

function setState(text,color){state.textContent=text; led.style.background=color;}
function stripFx(s){return String(s||'').replace(/\^[0-9]/g,'');}
function normalize(s){return stripFx(s).toLowerCase();}
function matchName(c,q,exact){if(typeof c!=='string')return false; const v=normalize(c), n=normalize(q); return exact? v===n : v.includes(n);}
function esc(s){return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function fmtName(name,q){const clean=stripFx(name); if(!hl.checked)return esc(clean); const i=clean.toLowerCase().indexOf(q.toLowerCase()); if(i<0)return esc(clean); return esc(clean.slice(0,i))+'<mark>'+esc(clean.slice(i,i+q.length))+'</mark>'+esc(clean.slice(i+q.length));}

async function runSearch(url, query, isExact){
  setState('Scanning…','#2dd4bf');
  const ac=new AbortController(); controller=ac;
  const res=await fetch(url,{signal:ac.signal,headers:{Accept:'text/event-stream'},cache:'no-store',mode:'cors'});
  if(!res.ok||!res.body) throw new Error('Stream not available ('+res.status+')');
  const reader=res.body.getReader(); const dec=new TextDecoder();
  let servers=0, matches=0, buf=""; let batch=[]; const qn=normalize(query);

  while(true){
    const {value,done}=await reader.read(); if(done)break;
    buf += dec.decode(value,{stream:true});
    const frames = buf.split(/\n\n/); buf = frames.pop() || '';
    for(const frame of frames){
      const dataLines = frame.split('\n').filter(l=>l.startsWith('data:'));
      for(const line of dataLines){
        let obj; try{ obj = JSON.parse(line.slice(5).trim()); }catch{ continue; }
        servers++;
        const id = obj.EndPoint || obj.endpoint || obj.ID || obj.id;
        const data = obj.Data || obj.data || {};
        const hostname = stripFx(data.hostname || '');
        const clients = data.clients ?? 0;
        const players = Array.isArray(data.players)? data.players : [];
        const found = players.filter(p=>matchName(p?.name, qn, isExact));
        if(found.length){
          for(const p of found){
            if(cap.checked && resultCount>=1500) break;
            const tr=document.createElement('tr');
            const nm=String(p?.name||'(unknown)');
            tr.innerHTML = `<td>${fmtName(nm, query)}</td>
                            <td>${esc(hostname)}</td>
                            <td><code>${esc(id||'')}</code></td>
                            <td>${Number(clients)||0}</td>
                            <td><a href="${JOIN_URL(id)}" target="_blank" rel="noopener">Join</a></td>
                            <td><a href="${DETAIL_URL(id)}" target="_blank" rel="noopener">Details</a></td>`;
            batch.push(tr); matches++; resultCount++;
          }
        }
        if(servers%200===0 || batch.length>=50){
          statusEl.textContent = `Servers scanned: ${servers.toLocaleString()} • Matches: ${matches.toLocaleString()}`;
          if(batch.length){ const frag=document.createDocumentFragment(); batch.forEach(r=>frag.appendChild(r)); tbody.appendChild(frag); batch=[]; }
        }
      }
    }
    if(stopFlag)break;
  }
  if(batch.length){ const frag=document.createDocumentFragment(); batch.forEach(r=>frag.appendChild(r)); tbody.appendChild(frag); }
  setState('Done','#22c55e');
}
</script>
</body>
</html>
